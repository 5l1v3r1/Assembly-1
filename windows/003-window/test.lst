     1                                  ; build window
     2                                  extern GetModuleHandleA
     3                                  extern CreateMutexA
     4                                  extern LoadImageA
     5                                  extern RegisterClassExA
     6                                  extern CreateWindowExA
     7                                  extern ShowWindow
     8                                  ; main loop
     9                                  extern PeekMessageA
    10                                  extern TranslateMessage
    11                                  extern DispatchMessageA
    12                                  extern DefWindowProcA
    13                                  
    14                                  ; shutdown/cleanup
    15                                  extern LocalFree
    16                                  extern ExitProcess
    17                                  
    18                                  ; error handling
    19                                  extern SetLastError
    20                                  extern GetLastError
    21                                  extern FormatMessageA
    22                                  extern GetStdHandle
    23                                  extern LocalSize
    24                                  extern WriteFile
    25                                  
    26                                  section .data
    27 00000000 00000000                GetLastError__errCode: dd 0
    28 00000004 00000000                GetLastError__msgLen: dd 0
    29 00000008 0000000000000000        GetLastError__msgBuf: dq 0
    30 00000010 00000000                Console__stderr_nStdHandle: dd 0
    31 00000014 00000000                Console__stdout_nStdHandle: dd 0
    32 00000018 00000000                Console__bytesWritten: dd 0
    33 0000001C 65343464373534352D-     Generic__uuid: db "e44d7545-f9df-418e-bc37-11ad4535d32f",0
    33 00000025 663964662D34313865-
    33 0000002E 2D626333372D313161-
    33 00000037 643435333564333266-
    33 00000040 00                 
    34 00000041 0000000000000000        CreateMutexA__handle: dq 0
    35 00000049 0000000000000000        GetModuleHandleA__hModule: dq 0
    36 00000051 0000000000000000        CreateWindow__icon: dq 0
    37 00000059 0000000000000000        CreateWindow__cursor: dq 0
    38                                  
    39                                  ; struct
    40                                  MainWindow_1: ; instanceof tagWNDCLASSEXA
    41 00000061 50000000                MainWindow_1.cbSize dd 80 ; UINT
    42 00000065 23000000                MainWindow_1.style dd 0x23 ; UINT = CS_OWNDC | CS_VREDRAW | CS_HREDRAW
    43 00000069 [8F02000000000000]      MainWindow_1.lpfnWndProc dq WndProc ; WNDPROC
    44 00000071 00000000                MainWindow_1.cbClsExtra dd 0 ; int
    45 00000075 00000000                MainWindow_1.cbWndExtra dd 0 ; int
    46 00000079 [4900000000000000]      MainWindow_1.hInstance dq GetModuleHandleA__hModule ; HINSTANCE
    47 00000081 [5100000000000000]      MainWindow_1.hIcon dq CreateWindow__icon ; HICON
    48 00000089 [5900000000000000]      MainWindow_1.hCursor dq CreateWindow__cursor ; HCURSOR
    49 00000091 0500000000000000        MainWindow_1.hbrBackground dq 5 ; HBRUSH
    50 00000099 0000000000000000        MainWindow_1.lpszMenuName dq 0 ; LPCSTR
    51 000000A1 [1C00000000000000]      MainWindow_1.lpszClassName dq Generic__uuid ; LPCSTR
    52 000000A9 0000000000000000        MainWindow_1.hIconSm dq 0 ; HICON
    53                                  
    54 000000B1 0000000000000000        CreateWindow__atom_name: dq 0
    55 000000B9 0000000000000000        CreateWindow__hwnd: dq 0
    56 000000C1 4F70656E474C204465-     CreateWindow__title: db "OpenGL Demo",0
    56 000000CA 6D6F00             
    57 000000CD 00000000                ShowWindow__successful: dd 0
    58                                  
    59                                  ; struct
    60                                  IncomingMessage_1: ; instanceof tagMSG
    61 000000D1 0000000000000000        IncomingMessage_1.hwnd dq 0 ; HWND
    62 000000D9 00000000                IncomingMessage_1.message dd 0 ; UINT
    63 000000DD 0000000000000000        IncomingMessage_1.wParam dq 0 ; WPARAM
    64 000000E5 0000000000000000        IncomingMessage_1.lParam dq 0 ; LPARAM
    65 000000ED 00000000                IncomingMessage_1.time dd 0 ; dword
    66 000000F1 00000000                IncomingMessage_1.pt.x dd 0 ; dword
    67 000000F5 00000000                IncomingMessage_1.pt.y dd 0 ; dword
    68 000000F9 00000000                IncomingMessage_1.lPrivate dd 0 ; dword
    69                                  
    70 000000FD 00000000                PeekMessage_hasMsgs: dd 0
    71 00000101 0000000000000000        nWndProc__hWnd: dq 0
    72 00000109 0000000000000000        nWndProc__uMsg: dq 0
    73 00000111 0000000000000000        nWndProc__wParam: dq 0
    74 00000119 0000000000000000        nWndProc__lParam: dq 0
    75 00000121 0000000000000000        nWndProc__return: dq 0
    76                                  
    77                                  section .text
    78                                  global main
    79                                  main:
    80                                  
    81                                  
    82                                  ; get pointers to stdout/stderr pipes
    83 00000000 E8F2020000              call near GetLastError__prologue_reset
    84                                  ; MS __fastcall x64 ABI
    85 00000005 4883EC28                sub rsp, 40 ; allocate shadow space
    86 00000009 B9F4FFFFFF              mov dword ecx, -12 ; 1st: DWORD nStdHandle = STD_ERROR_HANDLE
    87 0000000E E8(00000000)            call GetStdHandle
    88 00000013 890425[10000000]        mov dword [Console__stderr_nStdHandle], eax ; return 
    89 0000001A 4883C428                add rsp, 40 ; deallocate shadow space
    90 0000001E E8E7020000              call near GetLastError__epilogue_check
    91                                  
    92 00000023 E8CF020000              call near GetLastError__prologue_reset
    93                                  ; MS __fastcall x64 ABI
    94 00000028 4883EC28                sub rsp, 40 ; allocate shadow space
    95 0000002C B9F5FFFFFF              mov dword ecx, -11 ; 1st: DWORD nStdHandle = STD_OUTPUT_HANDLE
    96 00000031 E8(00000000)            call GetStdHandle
    97 00000036 890425[14000000]        mov dword [Console__stdout_nStdHandle], eax ; return 
    98 0000003D 4883C428                add rsp, 40 ; deallocate shadow space
    99 00000041 E8C4020000              call near GetLastError__epilogue_check
   100                                  
   101                                  
   102 00000046 E8AC020000              call near GetLastError__prologue_reset
   103                                  ; MS __fastcall x64 ABI
   104 0000004B 4883EC28                sub rsp, 40 ; allocate shadow space
   105 0000004F 41B8[1C000000]          mov dword r8d, Generic__uuid ; 3rd: LPCSTR lpName
   106 00000055 BA01000000              mov dword edx, 1 ; 2nd: BOOL bInitialOwner
   107 0000005A B900000000              mov dword ecx, 0 ; 1st: LPSECURITY_ATTRIBUTES lpMutexAttributes
   108 0000005F E8(00000000)            call CreateMutexA
   109 00000064 48890425[41000000]      mov qword [CreateMutexA__handle], rax ; return HANDLE
   110 0000006C 4883C428                add rsp, 40 ; deallocate shadow space
   111 00000070 E895020000              call near GetLastError__epilogue_check
   112                                  
   113 00000075 E87D020000              call near GetLastError__prologue_reset
   114                                  ; MS __fastcall x64 ABI
   115 0000007A 4883EC28                sub rsp, 40 ; allocate shadow space
   116 0000007E B900000000              mov dword ecx, 0 ; 1st: LPCSTR lpModuleName
   117 00000083 E8(00000000)            call GetModuleHandleA
   118 00000088 48890425[49000000]      mov qword [GetModuleHandleA__hModule], rax ; return HMODULE *phModule
   119 00000090 4883C428                add rsp, 40 ; deallocate shadow space
   120 00000094 E871020000              call near GetLastError__epilogue_check
   121                                  
   122 00000099 E859020000              call near GetLastError__prologue_reset
   123                                  ; MS __fastcall x64 ABI
   124 0000009E 4883EC38                sub rsp, 56 ; allocate shadow space
   125 000000A2 C744242840800000        mov dword [rsp + 40], 0x8040 ; 6th: UINT fuLoad = LR_SHARED | LR_DEFAULTSIZE
   126 000000AA C744242000000000        mov dword [rsp + 32], 0 ; 5th: int cy
   127 000000B2 41B900000000            mov dword r9d, 0 ; 4th: int cx
   128 000000B8 41B801000000            mov dword r8d, 1 ; 3rd: UINT type = IMAGE_ICON
   129 000000BE BA057F0000              mov dword edx, 32517 ; 2nd: LPCSTR name = OIC_WINLOGO
   130 000000C3 B900000000              mov dword ecx, 0 ; 1st: HINSTANCE hInst
   131 000000C8 E8(00000000)            call LoadImageA
   132 000000CD 48890425[51000000]      mov qword [CreateWindow__icon], rax ; return HANDLE
   133 000000D5 4883C438                add rsp, 56 ; deallocate shadow space
   134 000000D9 E82C020000              call near GetLastError__epilogue_check
   135                                  
   136 000000DE E814020000              call near GetLastError__prologue_reset
   137                                  ; MS __fastcall x64 ABI
   138 000000E3 4883EC38                sub rsp, 56 ; allocate shadow space
   139 000000E7 C744242840800000        mov dword [rsp + 40], 0x8040 ; 6th: UINT fuLoad = LR_SHARED | LR_DEFAULTSIZE
   140 000000EF C744242000000000        mov dword [rsp + 32], 0 ; 5th: int cy
   141 000000F7 41B900000000            mov dword r9d, 0 ; 4th: int cx
   142 000000FD 41B802000000            mov dword r8d, 2 ; 3rd: UINT type = IMAGE_CURSOR
   143 00000103 BA007F0000              mov dword edx, 32512 ; 2nd: LPCSTR name = IDC_ARROW
   144 00000108 B900000000              mov dword ecx, 0 ; 1st: HINSTANCE hInst
   145 0000010D E8(00000000)            call LoadImageA
   146 00000112 48890425[59000000]      mov qword [CreateWindow__cursor], rax ; return HANDLE
   147 0000011A 4883C438                add rsp, 56 ; deallocate shadow space
   148 0000011E E8E7010000              call near GetLastError__epilogue_check
   149                                  
   150 00000123 E8CF010000              call near GetLastError__prologue_reset
   151                                  ; MS __fastcall x64 ABI
   152 00000128 4883EC28                sub rsp, 40 ; allocate shadow space
   153 0000012C 48B9-                   mov qword rcx, MainWindow_1 ; 1st: WNDCLASSEXA *Arg1
   153 0000012E [6100000000000000] 
   154 00000136 E8(00000000)            call RegisterClassExA
   155 0000013B 48890425[B1000000]      mov qword [CreateWindow__atom_name], rax ; return 
   156 00000143 4883C428                add rsp, 40 ; deallocate shadow space
   157 00000147 E8BE010000              call near GetLastError__epilogue_check
   158                                  
   159 0000014C E8A6010000              call near GetLastError__prologue_reset
   160                                  ; MS __fastcall x64 ABI
   161 00000151 4883EC68                sub rsp, 104 ; allocate shadow space
   162 00000155 48C744245800000000      mov qword [rsp + 88], 0 ; 12th: LPVOID lpParam
   163 0000015E 48C7442450-             mov qword [rsp + 80], GetModuleHandleA__hModule ; 11th: HINSTANCE hInstance
   163 00000163 [49000000]         
   164 00000167 48C744244800000000      mov qword [rsp + 72], 0 ; 10th: HMENU hMenu
   165 00000170 48C744244000000000      mov qword [rsp + 64], 0 ; 9th: HWND hWndParent
   166 00000179 C7442438E0010000        mov dword [rsp + 56], 480 ; 8th: int nHeight
   167 00000181 C744243080020000        mov dword [rsp + 48], 640 ; 7th: int nWidth
   168 00000189 C744242800000080        mov dword [rsp + 40], 0x80000000 ; 6th: int Y
   169 00000191 C744242000000080        mov dword [rsp + 32], 0x80000000 ; 5th: int X
   170 00000199 41B90000CF16            mov qword r9, 0x16cf0000 ; 4th: DWORD dwStyle = WS_OVERLAPPEDWINDOW | WS_VISIBLE | WS_CLIPCHILDREN | WS_CLIPSIBLINGS
   171 0000019F 49B8-                   mov qword r8, CreateWindow__title ; 3rd: LPCSTR lpWindowName
   171 000001A1 [C100000000000000] 
   172 000001A9 48BA-                   mov qword rdx, Generic__uuid ; 2nd: LPCSTR lpClassName
   172 000001AB [1C00000000000000] 
   173 000001B3 B900030000              mov qword rcx, 768 ; 1st: DWORD dwExStyle = WS_EX_OVERLAPPEDWINDOW
   174 000001B8 E8(00000000)            call CreateWindowExA
   175 000001BD 48890425[B9000000]      mov qword [CreateWindow__hwnd], rax ; return HWND
   176 000001C5 4883C468                add rsp, 104 ; deallocate shadow space
   177 000001C9 E83C010000              call near GetLastError__epilogue_check
   178                                  
   179 000001CE E824010000              call near GetLastError__prologue_reset
   180                                  ; MS __fastcall x64 ABI
   181 000001D3 4883EC28                sub rsp, 40 ; allocate shadow space
   182 000001D7 BA01000000              mov dword edx, 1 ; 2nd: int nCmdShow
   183 000001DC 488B0C25[B9000000]      mov qword rcx, [CreateWindow__hwnd] ; 1st: HWND hWnd
   184 000001E4 E8(00000000)            call ShowWindow
   185 000001E9 890425[CD000000]        mov dword [ShowWindow__successful], eax ; return BOOL successful
   186 000001F0 4883C428                add rsp, 40 ; deallocate shadow space
   187 000001F4 E811010000              call near GetLastError__epilogue_check
   188                                  
   189                                  Loop:
   190 000001F9 E8F9000000              call near GetLastError__prologue_reset
   191                                  ; MS __fastcall x64 ABI
   192 000001FE 4883EC30                sub rsp, 48 ; allocate shadow space
   193 00000202 C744242001000000        mov dword [rsp + 32], 1 ; 5th: UINT wRemoveMsg = PM_REMOVE
   194 0000020A 41B900000000            mov dword r9d, 0 ; 4th: UINT wMsgFilterMax
   195 00000210 41B800000000            mov dword r8d, 0 ; 3rd: UINT wMsgFilterMin
   196 00000216 488B1425[B9000000]      mov qword rdx, [CreateWindow__hwnd] ; 2nd: HWND hWnd
   197 0000021E 48B9-                   mov qword rcx, IncomingMessage_1 ; 1st: LPMSG lpMsg
   197 00000220 [D100000000000000] 
   198 00000228 E8(00000000)            call PeekMessageA
   199 0000022D 890425[FD000000]        mov dword [PeekMessage_hasMsgs], eax ; return BOOL
   200 00000234 4883C430                add rsp, 48 ; deallocate shadow space
   201 00000238 E8CD000000              call near GetLastError__epilogue_check
   202                                  
   203 0000023D 4883F800                cmp rax, 0
   204 00000241 0F84B2FFFFFF            je near Loop
   205 00000247 E8AB000000              call near GetLastError__prologue_reset
   206                                  ; MS __fastcall x64 ABI
   207 0000024C 4883EC28                sub rsp, 40 ; allocate shadow space
   208 00000250 48B9-                   mov qword rcx, IncomingMessage_1 ; 1st: LPMSG lpMsg
   208 00000252 [D100000000000000] 
   209 0000025A E8(00000000)            call TranslateMessage
   210 0000025F 4883C428                add rsp, 40 ; deallocate shadow space
   211 00000263 E8A2000000              call near GetLastError__epilogue_check
   212                                  
   213 00000268 E88A000000              call near GetLastError__prologue_reset
   214                                  ; MS __fastcall x64 ABI
   215 0000026D 4883EC28                sub rsp, 40 ; allocate shadow space
   216 00000271 48B9-                   mov qword rcx, IncomingMessage_1 ; 1st: LPMSG lpMsg
   216 00000273 [D100000000000000] 
   217 0000027B E8(00000000)            call DispatchMessageA
   218 00000280 4883C428                add rsp, 40 ; deallocate shadow space
   219 00000284 E881000000              call near GetLastError__epilogue_check
   220                                  
   221 00000289 0F846AFFFFFF            je near Loop
   222                                  
   223                                  WndProc:
   224 0000028F 48890C25[01010000]      mov qword [nWndProc__hWnd], rcx
   225 00000297 48891425[09010000]      mov qword [nWndProc__uMsg], rdx
   226 0000029F 4C890425[11010000]      mov qword [nWndProc__wParam], r8
   227 000002A7 4C890C25[19010000]      mov qword [nWndProc__lParam], r9
   228 000002AF E843000000              call near GetLastError__prologue_reset
   229                                  ; MS __fastcall x64 ABI
   230 000002B4 4883EC28                sub rsp, 40 ; allocate shadow space
   231 000002B8 4C8B0C25[19010000]      mov qword r9, [nWndProc__lParam] ; 4th: 
   232 000002C0 4C8B0425[11010000]      mov qword r8, [nWndProc__wParam] ; 3rd: 
   233 000002C8 488B1425[09010000]      mov qword rdx, [nWndProc__uMsg] ; 2nd: 
   234 000002D0 488B0C25[01010000]      mov qword rcx, [nWndProc__hWnd] ; 1st: 
   235 000002D8 E8(00000000)            call DefWindowProcA
   236 000002DD 48890425[21010000]      mov qword [nWndProc__return], rax ; return 
   237 000002E5 4883C428                add rsp, 40 ; deallocate shadow space
   238 000002E9 E81C000000              call near GetLastError__epilogue_check
   239                                  
   240 000002EE 488B0425[21010000]      mov qword rax, [nWndProc__return]
   241 000002F6 C3                      ret
   242                                  
   243                                  GetLastError__prologue_reset:
   244                                  ; MS __fastcall x64 ABI
   245 000002F7 4883EC28                sub rsp, 40 ; allocate shadow space
   246 000002FB B900000000              mov dword ecx, 0 ; 1st: DWORD dwErrCode
   247 00000300 E8(00000000)            call SetLastError
   248 00000305 4883C428                add rsp, 40 ; deallocate shadow space
   249 00000309 C3                      ret
   250                                  
   251                                  GetLastError__epilogue_check:
   252                                  ; MS __fastcall x64 ABI
   253 0000030A 4883EC28                sub rsp, 40 ; allocate shadow space
   254 0000030E E8(00000000)            call GetLastError
   255 00000313 890425[00000000]        mov dword [GetLastError__errCode], eax ; return 
   256 0000031A 4883C428                add rsp, 40 ; deallocate shadow space
   257 0000031E 4883F800                cmp rax, 0
   258 00000322 7501                    jne ..@error
   259 00000324 C3                      ret
   260                                  
   261                                  ..@error:
   262                                  ; MS __fastcall x64 ABI
   263 00000325 4883EC40                sub rsp, 64 ; allocate shadow space
   264 00000329 C744243000000000        mov dword [rsp + 48], 0 ; 7th: va_list *Arguments
   265 00000331 C744242800000000        mov dword [rsp + 40], 0 ; 6th: DWORD nSize
   266 00000339 C7442420[08000000]      mov dword [rsp + 32], GetLastError__msgBuf ; 5th: LPSTR lpBuffer
   267 00000341 41B900040000            mov dword r9d, 0x400 ; 4th: DWORD dwLanguageId = LANG_USER_DEFAULT, SUBLANG_DEFAULT
   268 00000347 448B0425[00000000]      mov dword r8d, [GetLastError__errCode] ; 3rd: DWORD dwMessageId
   269 0000034F BA00000000              mov dword edx, 0 ; 2nd: LPCVOID lpSource
   270 00000354 B900130000              mov dword ecx, 0x1300 ; 1st: DWORD dwFlags = FORMAT_MESSAGE_ALLOCATE_BUFFER | FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS
   271 00000359 E8(00000000)            call FormatMessageA
   272 0000035E 4883C440                add rsp, 64 ; deallocate shadow space
   273                                  
   274                                  ; MS __fastcall x64 ABI
   275 00000362 4883EC28                sub rsp, 40 ; allocate shadow space
   276 00000366 8B0C25[08000000]        mov dword ecx, [GetLastError__msgBuf] ; 1st: HLOCAL hMem
   277 0000036D E8(00000000)            call LocalSize
   278 00000372 890425[04000000]        mov dword [GetLastError__msgLen], eax ; return 
   279 00000379 4883C428                add rsp, 40 ; deallocate shadow space
   280                                  ; MS __fastcall x64 ABI
   281 0000037D 4883EC30                sub rsp, 48 ; allocate shadow space
   282 00000381 C744242000000000        mov dword [rsp + 32], 0 ; 5th: LPOVERLAPPED lpOverlapped
   283 00000389 41B9[18000000]          mov dword r9d, Console__bytesWritten ; 4th: LPDWORD lpNumberOfBytesWritten
   284 0000038F 448B0425[04000000]      mov dword r8d, [GetLastError__msgLen] ; 3rd: DWORD nNumberOfBytesToWrite
   285 00000397 8B1425[08000000]        mov dword edx, [GetLastError__msgBuf] ; 2nd: LPCVOID lpBuffer
   286 0000039E 8B0C25[14000000]        mov dword ecx, [Console__stdout_nStdHandle] ; 1st: HANDLE hFile
   287 000003A5 E8(00000000)            call WriteFile
   288 000003AA 4883C430                add rsp, 48 ; deallocate shadow space
   289                                  
   290                                  ; cleanup
   291                                  ; MS __fastcall x64 ABI
   292 000003AE 4883EC28                sub rsp, 40 ; allocate shadow space
   293 000003B2 8B0C25[08000000]        mov dword ecx, [GetLastError__msgBuf] ; 1st: _Frees_ptr_opt_ HLOCAL hMem
   294 000003B9 E8(00000000)            call LocalFree
   295 000003BE 4883C428                add rsp, 40 ; deallocate shadow space
   296 000003C2 8B0C25[00000000]        mov ecx, [GetLastError__errCode] ; UINT uExitCode
   297 000003C9 E900000000              jmp near Exit
   298                                  
   299                                  Exit:
   300                                  ; MS __fastcall x64 ABI
   301 000003CE 4883EC28                sub rsp, 40 ; allocate shadow space
   302 000003D2 E8(00000000)            call ExitProcess
   303 000003D7 4883C428                add rsp, 40 ; deallocate shadow space
   304                                  
   305                                  
